"""Configuration management for the Prediction MCP server."""

from __future__ import annotations

import os
from pathlib import Path
from typing import Any, Dict, Optional

from dotenv import load_dotenv

DEFAULT_DB_PATH = "polymarket_read.db"


class ConfigManager:
    """Load and manage environment-driven configuration."""

    def __init__(self, env_file: Optional[Path] = None) -> None:
        self.env_file = env_file or Path(".env")

        env_override = os.getenv("PREDICTION_CONFIG_FILE")
        if env_override and not env_file:
            self.env_file = Path(env_override).expanduser()

        if self.env_file.exists():
            load_dotenv(self.env_file)
        else:
            load_dotenv(override=False)

    def get_config(self) -> Dict[str, Any]:
        """Return current configuration values."""
        return {
            "db_path": os.getenv("PREDICTION_DB_PATH") or DEFAULT_DB_PATH,
            "gemini_api_key": os.getenv("GEMINI_API_KEY", ""),
            "default_limit": int(os.getenv("PREDICTION_DEFAULT_LIMIT", "25") or 25),
        }

    def validate_config(self) -> bool:
        """Validate that the configured database is accessible."""
        config = self.get_config()
        db_path = Path(config["db_path"])
        return db_path.exists() and db_path.is_file()

    def setup_env_file(
        self,
        db_path: Optional[str] = None,
        gemini_api_key: Optional[str] = None,
        default_limit: Optional[int] = None,
    ) -> bool:
        """Create or update a .env file with prediction MCP settings."""
        try:
            current = self.get_config()

            if not db_path:
                prompt_default = current["db_path"] or DEFAULT_DB_PATH
                entered = input(
                    f"Path to read-only prediction markets database "
                    f"[{prompt_default}]: "
                ).strip()
                db_path = entered or prompt_default

            if gemini_api_key is None:
                prompt_default = current["gemini_api_key"]
                entered = input(
                    "Gemini API key (leave blank to keep existing/skip): "
                ).strip()
                gemini_api_key = (
                    entered if entered else (prompt_default if prompt_default else "")
                )

            if default_limit is None:
                prompt_default = current["default_limit"]
                entered = input(
                    f"Default result limit for SQL tools [{prompt_default}]: "
                ).strip()
                try:
                    default_limit = int(entered) if entered else prompt_default
                except ValueError:
                    print("Invalid limit provided, falling back to 25.")
                    default_limit = 25

            content = (
                "# Prediction MCP Server configuration\n"
                "# Generated by prediction-mcp-server init\n\n"
                f"PREDICTION_DB_PATH={db_path}\n"
                f"GEMINI_API_KEY={gemini_api_key}\n"
                f"PREDICTION_DEFAULT_LIMIT={default_limit}\n"
            )

            self.env_file.write_text(content)
            print(f"✓ Configuration saved to {self.env_file}")

            if not Path(db_path).exists():
                print("⚠️  Warning: database path does not exist yet.")

            if not gemini_api_key:
                print("⚠️  Gemini API key not set. Intelligent chat tool will be disabled.")

            return True
        except Exception as exc:
            print(f"Error creating configuration: {exc}")
            return False

    def get_config_summary(self) -> str:
        """Return a human-readable configuration summary."""
        config = self.get_config()
        db_path = Path(config["db_path"])
        db_status = "exists" if db_path.exists() else "missing"
        gemini_status = (
            f"{config['gemini_api_key'][:8]}..." if config["gemini_api_key"] else "not set"
        )

        return (
            f"Prediction MCP configuration\n"
            f"- Database: {db_path} ({db_status})\n"
            f"- Gemini API key: {gemini_status}\n"
            f"- Default limit: {config['default_limit']}\n"
            f"- Env file: {self.env_file} "
            f"(present: {self.env_file.exists()})"
        )
